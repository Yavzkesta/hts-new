---
import NewsCard from '~/components/news/NewsCard.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import AccessibleButton from '~/components/ui/AccessibleButton.astro';

interface Props {
  articles: any[];
  sectionTitle: string;
  lang: string;
}

const { articles, sectionTitle, lang } = Astro.props;

// Textes pour l'accessibilité selon la langue
const prevText = lang === 'fr' ? 'Article précédent' : 'Previous article';
const nextText = lang === 'fr' ? 'Article suivant' : 'Next article';
---

<WidgetWrapper id="related-articles" isDark={true} containerClass="max-w-6xl mx-auto">
  <Headline title={sectionTitle} />

  <div class="relative intersect-once">
    <!-- Slider container -->
    <div class="overflow-hidden">
      <div id="articles-slider" class="flex transition-transform duration-500 ease-in-out">
        {
          articles.map((article) => {
            // Extraire le slug sans le préfixe de langue
            const cleanSlug = article.slug.includes('/') ? article.slug.split('/').pop() : article.slug;

            return (
              <div class="flex-shrink-0 w-full sm:w-1/2 lg:w-1/3 xl:w-1/4 px-4">
                <NewsCard
                  title={article.data.title}
                  description={article.data.description}
                  image={article.data.image}
                  imageAlt={article.data.imageAlt}
                  publishDate={article.data.publishDate}
                  category={article.data.category}
                  tags={article.data.tags}
                  slug={article.slug}
                  lang={lang}
                />
              </div>
            );
          })
        }
      </div>
    </div>

    <!-- Navigation buttons utilisant le composant AccessibleButton -->
    <div class="relative">
      <AccessibleButton 
        id="prev-btn" 
        label={prevText} 
        direction="prev" 
      />
      <AccessibleButton 
        id="next-btn" 
        label={nextText} 
        direction="next" 
      />
    </div>
  </div>
</WidgetWrapper>

<script define:vars={{ prevText, nextText }}>
  document.addEventListener('DOMContentLoaded', () => {
    const slider = document.getElementById('articles-slider');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    if (!slider || !prevBtn || !nextBtn) return;

    let currentIndex = 0;
    const itemsPerView = window.innerWidth < 640 ? 1 : window.innerWidth < 1024 ? 2 : window.innerWidth < 1280 ? 3 : 4;
    const totalItems = slider.children.length;
    const maxIndex = Math.max(0, totalItems - itemsPerView);

    const updateSlider = () => {
      const translateX = -(currentIndex * (100 / itemsPerView));
      slider.style.transform = `translateX(${translateX}%)`;

      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === maxIndex;
      
      // Mettre à jour les attributs d'accessibilité
      prevBtn.setAttribute('aria-disabled', currentIndex === 0 ? 'true' : 'false');
      nextBtn.setAttribute('aria-disabled', currentIndex === maxIndex ? 'true' : 'false');
    };

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateSlider();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateSlider();
      }
    });

    updateSlider();

    window.addEventListener('resize', () => {
      const newItemsPerView = window.innerWidth < 640 ? 1 : window.innerWidth < 1024 ? 2 : window.innerWidth < 1280 ? 3 : 4;
      if (newItemsPerView !== itemsPerView) {
        currentIndex = 0;
        updateSlider();
      }
    });
  });
</script>